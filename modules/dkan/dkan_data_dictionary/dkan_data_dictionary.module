<?php

/**
 * @file
 * Code for the DKAN Data Dictionary feature.
 */

include_once 'dkan_data_dictionary.features.inc';

/**
 * Implements hook_form_FORM_ID_alter().
 */
function dkan_data_dictionary_form_resource_node_form_alter(&$form, &$form_state) {
  // Load jsoneditor libray and attach to resource form.
  $form['#attached']['libraries_load'][] = array('jsoneditor');
  $form['#attached']['js'][] = drupal_get_path('module', 'dkan_data_dictionary') . '/js/editor.js';
  drupal_add_css(drupal_get_path('module', 'dkan_data_dictionary') . '/css/dkan_data_dictionary.css');
}

/**
 * Implements hook_libraries_info().
 */
function dkan_data_dictionary_libraries_info() {
  $libraries = array();
  $libraries['jsoneditor'] = array(
    'name' => 'JSONEditor',
    'vendor url' => 'https://github.com/josdejong/jsoneditor',
    'download url' => 'https://github.com/josdejong/jsoneditor/archive/master.zip',
    'path' => '',
    'version arguments' => array(
      'file' => 'package.json',
      'pattern' => '/"version": "(\d+\.\d+\.\d+)"/',
    ),
    'files' => array(
      'js' => array(
        'dist/jsoneditor.min.js',
      ),
      'css' => array(
        'dist/jsoneditor.min.css',
      ),
    ),
  );
  return $libraries;
}

/**
* Implements hook_field_formatter_info().
*/
function dkan_data_dictionary_field_formatter_info() {
  return array(
    'text_schema_table' => array(
      'label' => t('Schema Table'),
      'field types' => array('text_long'),
    ),
  );
}

/**
 * Implements hook_field_formatter_view().
 */
function dkan_data_dictionary_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
  $settings = $display['settings'];
  $elements = array();

  if ($display['type'] == 'text_schema_table') {
    foreach ($items as $delta => $item) {
      $schema = json_decode($item['value']);

      if (json_last_error() === JSON_ERROR_NONE && property_exists($schema, 'fields')) {
        // Parse the schema array and build the table.
        $rows = array();

        foreach ($schema->fields as $field) {
          $name = (property_exists($field, 'name')) ? $field->name : '';
          $type = (property_exists($field, 'type')) ? $field->type : '';
          $format = (property_exists($field, 'format')) ? $field->format : 'default';
          $description = (property_exists($field, 'description')) ? $field->description : '';
          $constraints = '';

          if (property_exists($field, 'constraints')) {
            $array = (array) $field->constraints;

            $constraints = implode(', ', array_map(
              function ($v, $k) { return sprintf("%s = %s", $k, $v); },
              $array,
              array_keys($array)
            ));

          }

          $rows[] = array($name, $type, $format, $description, $constraints);
        }

        $elements[$delta] = array(
          '#theme' => 'table',
          '#header' => array(
            t('Name'),
            t('Type'),
            t('Format'),
            t('Description'),
            t('Constraints'),
          ),
          '#rows' => $rows,
        );

      }
      else {
        // If the supplied value isn't valid JSON or it is valid JSON but
        // isn't a schema containing fields - simply output the raw text.
        $elements[$delta] = array('#markup' => $item['value']);
      }
    }
  }

  return $elements;
}
