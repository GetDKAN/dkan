<?php

/**
 * @file
 * Creates DKAN Datastore.
 */

include_once "dkan_datastore.features.inc";

use \Dkan\Datastore\Manager\ManagerInterface;
use \Dkan\Datastore\Manager\Factory;
use \Dkan\Datastore\Resource;

/**
 * Implements hook_services_resources().
 */
function dkan_datastore_services_resources() {
  return array(
    'datastore' => array(
      'operations' => array(
        'retrieve' => array(
          'help' => 'Retrieve information about a datastore',
          'file' => array('type' => 'inc', 'module' => 'dkan_datastore', 'name' => 'resources/dkan_datastore_resource'),
          'callback' => '_dkan_datastore_resource_retrieve',
          'args' => array(
            array(
              'name' => 'resource_nid',
              'optional' => FALSE,
              'source' => array('path' => 0),
              'type' => 'int',
              'description' => 'The nid of the resource the datastore is connected to.',
            ),
          ),
          'access callback' => '_dkan_datastore_resource_access',
        ),
        'create' => array(
          'help' => 'Create a datastore for the given resource.',
          'file' => array('type' => 'inc', 'module' => 'dkan_datastore', 'name' => 'resources/dkan_datastore_resource'),
          'callback' => '_dkan_datastore_resource_create',
          'args' => array(
            array(
              'name' => 'nid',
              'optional' => FALSE,
              'source' => array('path' => 0),
              'type' => 'int',
              'description' => 'The nid of the resource to configure a datastore for.',
            ),
            array(
              'name' => 'manager',
              'optional' => FALSE,
              'type' => 'string',
              'source' => 'data',
              'description' => 'The machine name of the datastore manager that should be used.',
            ),
            array(
              'name' => 'configuration',
              'optional' => FALSE,
              'type' => 'object',
              'source' => 'data',
              'description' => 'An array of keys and values with the specific configuration for the given manager.',
            ),
          ),
          'access callback' => '_dkan_datastore_resource_access',
        ),
        /*'update' => array(
          'help' => 'Update a node',
          'file' => array('type' => 'inc', 'module' => 'services', 'name' => 'resources/node_resource'),
          'callback' => '_node_resource_update',
          'args' => array(
            array(
              'name' => 'nid',
              'optional' => FALSE,
              'source' => array('path' => 0),
              'type' => 'int',
              'description' => 'The nid of the node to update',
            ),
            array(
              'name' => 'node',
              'optional' => FALSE,
              'source' => 'data',
              'description' => 'The node data to update',
              'type' => 'array',
            ),
          ),
          'access callback' => '_node_resource_access',
          'access arguments' => array('update'),
          'access arguments append' => TRUE,
        ),
        'delete' => array(
          'help' => t('Delete a node'),
          'file' => array('type' => 'inc', 'module' => 'services', 'name' => 'resources/node_resource'),
          'callback' => '_node_resource_delete',
          'args' => array(
            array(
              'name' => 'nid',
              'optional' => FALSE,
              'source' => array('path' => 0),
              'type' => 'int',
              'description' => 'The nid of the node to delete',
            ),
          ),
          'access callback' => '_node_resource_access',
          'access arguments' => array('delete'),
          'access arguments append' => TRUE,
        ),*/
      ),
    ),
  );

  /*return array(
    'dkan_datastore' => array(
      'targeted_actions' => array(
        'import' => array(

        ),

      'actions' => array(
        'info' => array(
          'file' => array('type' => 'inc', 'module' => 'dkan_datastore', 'name' => 'resources/dkan_datastore_resource'),
          'callback' => '_dkan_datastore_resource_info',
          'access callback' => '_dkan_datastore_resource_import_access',
        ),
      ),
    ),
  );*/
}

/**
 * Implements hook_menu().
 */
function dkan_datastore_menu() {

  // @todo Move somewhere else.
  $items['node/%dkan_datastore_resource/download'] = array(
    'title callback' => 'dkan_datastore_download_title',
    'title arguments' => array(1),
    'page callback' => 'dkan_datastore_download',
    'page arguments' => array(1),
    'access callback' => 'dkan_datastore_download_access',
    'access arguments' => array('view', 1),
    'file' => 'dkan_datastore.pages.inc',
    'weight' => '20',
    'type' => MENU_LOCAL_TASK,
  );

  // @todo Move somewhere else.
  $items['node/%dkan_datastore_resource/data'] = array(
    'page callback' => 'dkan_datastore_proxy',
    'page arguments' => array(1),
    'access callback' => 'dkan_datastore_download_access',
    'access arguments' => array('view', 1),
    'file' => 'dkan_datastore.pages.inc',
    'type' => MENU_CALLBACK,
  );

  $items['node/%node/datastore'] = array(
    'title' => 'Manage Datastore',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('dkan_datastore_pages', 1, "importForm"),
    'access callback' => 'dkan_datastore_feeds_access',
    'access arguments' => array('import', 1),
    'file' => 'dkan_datastore.pages.inc',
    'weight' => '15',
    'type' => MENU_LOCAL_TASK,
  );
  $items['node/%node/datastore/import'] = array(
    'title' => 'Import',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('dkan_datastore_pages', 1, "importForm"),
    'access callback' => 'dkan_datastore_feeds_access',
    'access arguments' => array('import', 1),
    'file' => 'dkan_datastore.pages.inc',
    'weight' => 10,
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );

  $items['node/%node/datastore/drop'] = array(
    'title' => 'Drop Datastore',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('dkan_datastore_pages', 1, "dropForm"),
    'access callback' => 'dkan_datastore_feeds_access',
    'access arguments' => array('drop', 1),
    'file' => 'dkan_datastore.pages.inc',
    'weight' => 12,
    'type' => MENU_LOCAL_TASK,
  );
  return $items;
}

function dkan_datastore_managers_info() {
  return module_invoke_all("dkan_datastore_manager");
}

/**
 * Retrieves the url and type to the physical resource.
 */
function dkan_datastore_resource_link_type($node) {
  $node_wrapper = entity_metadata_wrapper('node', $node);
  $file_field = dkan_datastore_file_upload_field();
  $remote_file_field = dkan_datastore_file_link_field();
  $api_field = dkan_datastore_api_link_field();
  $type = dkan_datastore_node_type();

  if ($node->type == $type && $file = $node_wrapper->{$file_field}->value()) {
    $uri = isset($file->uri) ? $file->uri : $file['uri'];
    $url = file_create_url($uri);
    return array('url' => $url, 'type' => 'upload');
  }
  elseif ($remote_file = $node_wrapper->{$remote_file_field}->value()) {
    return array('url' => $remote_file['uri'], 'type' => 'remote');
  }
  elseif ($link = $node_wrapper->{$api_field}->value()) {
    return array('url' => $link['url'], 'type' => 'link');
  }
  else {
    drupal_set_message(t('No download available for this resource'));
    return array('type' => 'upload');
  }
}

/**
 * Retrive download title for a resource.
 *
 * Title callback to change the download link text
 * based on the type of the resource link.
 */
function dkan_datastore_download_title($node) {
  $resource_link_type = dkan_datastore_resource_link_type($node);
  return ($resource_link_type['type'] == 'link') ? t('Go to resource') : t('Download');
}

/**
 * Implements hook_menu_alter().
 */
function dkan_datastore_menu_alter(&$items) {
  // Removing these here, readding in hook_menu().
  unset($items['node/%node/delete-items']);
  unset($items['node/%node/import']);
  unset($items['node/%node/unlock']);
}

/**
 * Access callback for DKAN Datastore operations.
 */
function dkan_datastore_feeds_access($action, $node) {

  // If $action is not one of the supported actions, return access denied.
  if (!in_array($action, array('import', 'clear', 'unlock', 'drop'))) {
    return FALSE;
  }

  // All available operations requires the 'manage datastore' permission.
  if (user_access('manage datastore') && node_access('update', $node) && $node->type == 'resource') {
    return TRUE;
  }

  return FALSE;
}

/**
 * Access callback for Download.
 */
function dkan_datastore_download_access($action, $resource) {
  $type = dkan_datastore_node_type();
  $node = is_object($resource) ? $resource : node_load($resource);

  if ($node->type != $type) {
    return FALSE;
  }

  return node_access('view', $node);
}

/**
 * Load node by id or uuid.
 */
function dkan_datastore_resource_load($id) {
  try {
    // Id is a nid.
    if (is_numeric($id)) {
      return node_load($id);
    }
    // Id is a uuid and uuid is installed.
    elseif (function_exists('entity_uuid_load')) {
      $node = entity_uuid_load('node', array($id));
      return ($node) ? reset($node) : FALSE;
    }

  }
  catch (Exception $e) {
    return FALSE;
  }

  return FALSE;
}

/**
 * Access callback for back link.
 */
function dkan_datastore_back_access($node) {
  if ($node->type != 'resource') {
    return FALSE;
  }
  else {
    return node_access('view', $node);
  }
}

/**
 * Access callback for 'Add Resource' tab.
 */
function dkan_add_resource($node) {
  if ($node->type != 'dataset') {
    return FALSE;
  }
  else {
    return _node_add_access();
  }
}

/**
 * Implements hook_node_update().
 */
function dkan_datastore_node_insert($node) {
  $type = dkan_datastore_node_type();
  if ($node->type == $type) {
    if (!isset($node->feeds)) {
      // Feeds only saves if there is a form present. We want this to work
      // programmatically as well.
      feeds_node_prepare($node);
      feeds_node_update($node);
    }
  }
}

/**
 * Implements hook_node_update().
 */
function dkan_datastore_node_update($node) {
  $type = dkan_datastore_node_type();
  if ($node->type == $type) {
    $file_field = dkan_datastore_file_upload_field();
    $link_field = dkan_datastore_file_link_field();
    // See if we have a file link or upload.
    $wrapper = entity_metadata_wrapper('node', $node);
    $file = $wrapper->{$file_field}->value();
    if (!$file) {
      $link = $wrapper->{$link_field}->value();
      if (isset($link) && isset($link['fid'])) {
        $file = file_load($link['fid']);
      }
      elseif (isset($link) && isset($link->fid)) {
        $file = $link;
      }
      else {
        $file = '';
      }
    }
    if ($file) {
      if (!isset($node->feeds)) {
        // Feeds only saves if there is a form present. We want this to work
        // programmatically as well.
        feeds_node_prepare($node);
      }
      // Remove node from feeds list if not csv.
      elseif ($file->filemime != 'text/csv') {
        feeds_node_delete($node);
      }
    }
  }
}

/**
 * Implements hook_permission().
 */
function dkan_datastore_permission() {
  return array(
    'manage datastore' => array(
      'title' => t('Manage Datastore'),
    ),
    'manage datastore settings' => array(
      'title' => t('Manage Datastore Settings'),
    ),
  );
}

/**
 * Implements hook_node_view().
 */
function dkan_datastore_node_view($node, $view_mode, $langcode) {

  /*$type = dkan_datastore_node_type();
  if ($node->type == $type) {
    $status = dkan_datastore_status($node);
    if (user_access('manage datastore') && $status && $view_mode == 'full') {
      if ($status == DKAN_DATASTORE_FILE_EXISTS) {
        drupal_set_message(t('Your file for this resource is not added to the datastore. Click "Manage Datastore" to import file into the datastore.'));
      }
      elseif ($status == DKAN_DATASTORE_EXISTS) {
        drupal_set_message(t('Your file for this resource has been added to the datastore.'));
      }
    }
  }*/
}

/**
 * Determines if a resource can be imported.
 */
function dkan_datastore_is_importable($file) {
  return (is_object($file) && $file->filemime == 'text/csv') || (is_array($file) && array_key_exists('filemime', $file) && $file['filemime'] == 'text/csv');
}

/**
 * Retrieves loaded file from resource node.
 */
function dkan_datastore_file_field($node) {
  $type = dkan_datastore_node_type();
  if (isset($node->type) && $node->type == $type) {
    $file_field = dkan_datastore_file_upload_field();
    $link_field = dkan_datastore_file_link_field();
    $wrapper = entity_metadata_wrapper('node', $node);
    $file = isset($wrapper->{$file_field}) ? $wrapper->{$file_field}->value() : '';
    $link = isset($wrapper->{$link_field}) ? $wrapper->{$link_field}->value() : '';
    if (isset($file)) {
      return $file;
    }
    elseif ($link) {
      return $link;
    }
  }
  return FALSE;
}

/**
 * Implements hook_field_formatter_info().
 */
function dkan_datastore_field_formatter_info() {
  $formatters = array(
    'dkan_datastore_status_formatter' => array(
      'label' => t('Datastore Status'),
      'field types' => array('recline_field'),
    ),
  );
  return $formatters;
}

/**
 * Implements hook_field_formatter_view().
 */
function dkan_datastore_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {

  $element = array();

  foreach ($items as $delta => $item) {
    $item['entity'] = $entity;
    $element[$delta] = array(
      '#theme' => 'dkan_datastore_status_formatter',
      '#item' => $item,
    );
  }

  return $element;
}

/**
 * Implements hook_theme().
 */
function dkan_datastore_theme() {
  return array(
    'dkan_datastore_status_formatter' => array(
      'variables' => array('item' => NULL),
    ),
  );
}

/**
 * Returns HTML for an recline field formatter.
 *
 * @param array $variables
 *   An associative array containing:
 *   - item: Associative array of recline field.
 *
 * @ingroup themeable
 */
function theme_dkan_datastore_status_formatter(array $variables) {
  $status = dkan_datastore_status($variables['item']['entity']);
  if ($status === DKAN_DATASTORE_FILE_EXISTS) {
    $title = t('A file has been uploaded but not added to the datastore');
    return '<span class="circle false" title="' . $title . '">' . t('Data ready to be added') . '</span>';
  }
  elseif ($status === DKAN_DATASTORE_EXISTS) {
    return '<span class="circle true">' . t('Datastore enabled') . '</span>';
  }
  return '<span class="circle na">' . t('Correct file type not attached to resource') . '</span>';
}

/**
 * Returns name of upload field.
 */
function dkan_datastore_file_upload_field() {
  static $field;
  if (!$field) {
    $field = 'field_upload';
    drupal_alter('dkan_datastore_file_upload_field', $field);
  }
  return $field;
}

/**
 * Returns name of link api field.
 */
function dkan_datastore_api_link_field() {
  static $field;
  if (!$field) {
    $field = 'field_link_api';
    drupal_alter('dkan_datastore_field_link_api', $field);
  }
  return $field;
}

/**
 * Returns name of remote file field.
 */
function dkan_datastore_file_link_field() {
  static $field;
  if (!$field) {
    $field = 'field_link_remote_file';
    drupal_alter('dkan_datastore_field_link_remote_file', $field);
  }
  return $field;
}

/**
 * Returns name of node type that the Datastore is attached to.
 */
function dkan_datastore_node_type() {
  static $node_type;
  if (!$node_type) {
    $node_type = 'resource';
    drupal_alter('dkan_datastore_node_type', $node_type);
  }
  return $node_type;
}

/**
 * Implements hook_feeds_after_import().
 */
function dkan_datastore_feeds_after_import(FeedsSource $source) {
  $importer_id = $source->importer->id;
  $importers = array('dkan_file', 'dkan_link');
  if (empty($source->exception) && in_array($importer_id, $importers)) {
    $node = node_load($source->feed_nid);
    $node = entity_metadata_wrapper('node', $node);
    $node->field_datastore_status->set(DKAN_DATASTORE_EXISTS);
    $node->save();
  }
}

/**
 * Implements hook_node_presave().
 */
function dkan_datastore_node_presave($node) {
  if (is_object($node) && $node->type == 'resource') {
    /*$wrap = entity_metadata_wrapper('node', $node);
    $wrap->field_datastore_status->set(dkan_datastore_status($node));*/
  }
}

/**
 * Implements hook_form_alter().
 */
function dkan_datastore_form_alter(&$form, &$form_state, $form_id) {
  if ($form['#form_id'] == 'views_exposed_form' && $form['#id'] == 'views-exposed-form-dkan-datasets-panel-pane-1') {
    // Redirect reset button to  main search page.
    $form['reset']['#submit'] = array('_dkan_datastore_search_redirect');
  }
}

/**
 * Callback to redirect to search url.
 */
function _dkan_datastore_search_redirect() {
  drupal_goto('/search');
}

function dkan_datastore_status($node) {
  $datastore = dkan_datastore_go($node->uuid);
  return $datastore->getStatus();
}

function dkan_datastore_cron() {
  $storage = new \Dkan\Datastore\LockableDrupalVariables("dkan_datastore");

  $bin = $storage->borrowBin();

  $already_importing = FALSE;

  $current_nid = NULL;
  foreach ($bin as $nid => $state) {
    if ($state['data_import'] == ManagerInterface::DATA_IMPORT_IN_PROGRESS) {
      $already_importing = TRUE;
      break;
    }
    elseif ($state['data_import'] == ManagerInterface::DATA_IMPORT_UNINITIALIZED) {
      $current_nid = $nid;
      break;
    }
  }
  $storage->returnBin($bin);

  if ($current_nid) {
    print_r(PHP_EOL . "DKAN DATASTORE: Starting Import of Resource {$nid}" . PHP_EOL);

    $resource = Resource::createFromDrupalNodeNid($current_nid);

    /* @var $datastore_manager ManagerInterface */
    $datastore_manager = Factory::create($resource);

    $finished = $datastore_manager->import();

    if ($finished) {
      print_r(PHP_EOL . "DKAN DATASTORE: Done Importing Resource {$current_nid}" . PHP_EOL);
    }
    else {
      $general = "DKAN DATASTORE: There was a problem while importing Resource {$current_nid}";
      $errors = $datastore_manager->getErrors();
      $error_string = implode(" | ", $errors);
      $final_error_string = "{$general} - {$error_string}";
      print_r(PHP_EOL . $final_error_string . PHP_EOL);
      watchdog("error", $final_error_string);
    }

  }
  else {
    if ($already_importing) {
      print_r(PHP_EOL . "DKAN DATASTORE: Already Importing {$nid}" . PHP_EOL);
    }
    else {
      print_r(PHP_EOL . "DKAN DATASTORE: No Resources to Import" . PHP_EOL);
    }
  }
}
