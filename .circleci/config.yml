version: 2

references:
  install_site: &install_site
    run:
      name: Install site
      command: |
        export PATH=$PATH:~/dkan-tools/bin
        dktl install
        
  install_tests: &install_tests
    run:
      name: Install tests
      command: |
        export PATH=$PATH:~/dkan-tools/bin
        dktl test:init

jobs:
  build:
    machine:
      image: circleci/classic:latest
    environment:
      DKTL_CHOWN: False
      DKTL_NO_PTY: True
    steps:
      - checkout
      - run:
          name: Package DKAN
          command: |
            mkdir ~/dkan
            mv ~/project/* ~/dkan
      - run:
          name: Install DKTL
          command: |
            cd ~
            git clone -b docker-compose-error https://github.com/GetDKAN/dkan-tools.git
            chmod 777 ./dkan-tools/bin/dktl
      - run:
          name: Make site
          command: |
            export PATH=$PATH:~/dkan-tools/bin
            cd ~/project
            dktl init
            mv ~/dkan .
            dktl make
      - persist_to_workspace:
          root: /home/circleci
          paths:
            - bin
            - dkan
            - dkan-tools
            - project

  unit_test:
    machine:
      image: circleci/classic:latest
    environment:
      DKTL_CHOWN: False
      DKTL_NO_PTY: True
    steps:
      - attach_workspace:
          at: /home/circleci
      - *install_site
      - *install_tests
      - run:
          name: Run unit tests
          command: |
            export PATH=$PATH:~/dkan-tools/bin
            dktl test:phpunit

  behat_test:
    machine:
      image: circleci/classic:latest
    environment:
      DKTL_CHOWN: False
      DKTL_NO_PTY: True
    parallelism: 3
    steps:
      - attach_workspace:
          at: /home/circleci
      - *install_site
      - *install_tests
      - run:
          name: Run behat tests
          command: |
            export PATH=$PATH:~/dkan-tools/bin
            test_list=$(mktemp)
            exit_status=0
            (cd dkan/test; circleci tests glob features/*.feature | circleci tests split --split-by=filesize )> $test_list
            while read file; do if ! dktl test:behat $file; then exit_status=1; echo "FAILED SCENARIO: $file"; fi; done < $test_list
            echo "exit_status = $exit_status";
            exit $exit_status

workflows:
  version: 2
  build_and_test:
    jobs:
      - build
      - unit_test:
          requires:
            - build
      - behat_test:
          requires:
            - build
