version: 2.1

commands:
  ddev:
    steps:
      - run:
          name: Install DDev
          command: |
            curl https://apt.fury.io/drud/gpg.key | sudo apt-key add -
            echo "deb https://apt.fury.io/drud/ * *" | sudo tee -a /etc/apt/sources.list.d/ddev.list
            sudo apt update && sudo apt install -y ddev
  prepare_build:
    parameters:
      upgrade:
        description: "If true, will install the latest stable version and test upgrade"
        default: false
        type: boolean
    steps:
      - run:
          name: Set up composer config
          command: |
            mkdir ~/.composer
            bash -c 'echo "{\"github-oauth\": {\"github.com\": \"$GITHUB_TOKEN\"}}"' > ~/.composer/auth.json
      - ddev
      - run:
          name: DDev Init
          command: |
            which ddev
            ddev --version
            ddev config --project-type drupal9 --docroot docroot --create-docroot
            ddev get https://github.com/GetDKAN/dkan-ddev-addon/archive/refs/heads/main.tar.gz
            ddev restart
            ddev dkan-init --force

  prepare_site:
    parameters:
      upgrade:
        description: "If true, will install the latest stable version and test upgrade"
        default: false
        type: boolean
    steps:
      - checkout:
          path: dkan
      - when:
          condition: << parameters.upgrade >>
          steps:
            - run:
                name: Install site and update to dev dkan
                command: |
                  ddev composer show getdkan/dkan
                  ddev dkan-site-install
                  ddev composer config repositories.dkan path dkan
                  ddev composer require getdkan/dkan:@dev --no-install
                  ddev composer update --no-interaction --no-progress
                  ddev composer show getdkan/dkan
                  ddev drush updb -y
                  ddev drush rq
      - unless:
          condition: << parameters.upgrade >>
          steps:
            - run:
                name: Install site
                command: |
                  ddev composer config repositories.dkan path dkan
                  ddev composer require getdkan/dkan:@dev
                  ddev composer show getdkan/dkan
                  ddev dkan-site-install
                  ddev drush updb -y
                  ddev drush rq

jobs:
  phpunit:
    machine:
      image: ubuntu-2004:current
    parameters:
      upgrade:
        description: "If true, will install the latest stable version and test upgrade"
        default: false
        type: boolean
    environment:
      TEST_RESULTS: /tmp/test-results
      DKTL_VERSION: "4.2.11"
    steps:
      - prepare_build:
          upgrade: << parameters.upgrade >>
      - prepare_site:
          upgrade: << parameters.upgrade >>

workflows:
  version: 2
  install_and_test:
    jobs:
      - phpunit:
          name: install_test_phpunit
  upgrade_and_test:
    jobs:
      - phpunit:
          name: upgrade_test_phpunit
          upgrade: true