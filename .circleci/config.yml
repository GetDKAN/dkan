version: 2.1

commands:
  install-ddev:
    steps:
      - run:
          name: Install DDev
          command: |
            curl https://apt.fury.io/drud/gpg.key | sudo apt-key add -
            echo "deb https://apt.fury.io/drud/ * *" | sudo tee -a /etc/apt/sources.list.d/ddev.list
            sudo apt update && sudo apt install -y ddev
  prepare_build:
    # TODO: Figure out the best way to share this build between the various jobs.
    parameters:
      upgrade:
        description: "If true, will install the latest stable version and test upgrade"
        default: false
        type: boolean
    steps:
      - run:
          name: Set up composer config
          command: |
            mkdir ~/.composer
            bash -c 'echo "{\"github-oauth\": {\"github.com\": \"$GITHUB_TOKEN\"}}"' > ~/.composer/auth.json
      - install-ddev
      - run:
          name: Build site codebase
          command: |
            which ddev
            ddev --version
            ddev config --project-type drupal9 --docroot docroot --create-docroot
            ddev get https://github.com/GetDKAN/dkan-ddev-addon/archive/refs/heads/main.tar.gz
            ddev restart
            ddev dkan-init --force

  prepare_site:
    parameters:
      upgrade:
        description: "If true, will install the latest stable version and test upgrade"
        default: false
        type: boolean
    steps:
      - checkout:
          path: dkan
      - run:
          # TODO: This hacks around the specific Cypress version requirement for DKAN. Find a better way.
          name: Cypressify ddev
          command: |
            mv .ddev/misc/docker-compose.cypress.yaml .ddev/docker-compose.cypress.yaml
            ddev restart
      - when:
          condition: << parameters.upgrade >>
          steps:
            - run:
                name: Install site and update to dev dkan
                command: |
                  ddev composer show getdkan/dkan
                  ddev dkan-site-install
                  ddev composer config repositories.dkan path dkan
                  ddev composer require getdkan/dkan:@dev --no-install
                  ddev composer update --no-interaction --no-progress
                  ddev composer show getdkan/dkan
                  ddev drush updb -y
                  ddev drush rq
      - unless:
          condition: << parameters.upgrade >>
          steps:
            - run:
                name: Install site
                command: |
                  ddev composer config repositories.dkan path dkan
                  ddev composer require getdkan/dkan:@dev
                  ddev composer show getdkan/dkan
                  ddev dkan-site-install
                  ddev drush updb -y
                  ddev drush rq

jobs:
  phpunit:
    machine:
      image: ubuntu-2004:current
    parameters:
      upgrade:
        description: "If true, will install the latest stable version and test upgrade"
        default: false
        type: boolean
    environment:
      TEST_RESULTS: /tmp/test-results
    steps:
      - prepare_build:
          upgrade: << parameters.upgrade >>
      - prepare_site:
          upgrade: << parameters.upgrade >>
      - when:
          condition: << parameters.upgrade >>
          steps:
            - run:
                name: Run PHPUnit tests
                command: ddev dkan-test-phpunit
      - unless:
          # Only collect coverage info for non-upgrade PHPUnit tests.
          condition: << parameters.upgrade >>
          steps:
            - run:
                name: Run PHPUnit tests with coverage report
                command: |
                  ddev xdebug on
                  ddev dkan-phpunit-test --coverage-clover $GITHUB_WORKSPACE/clover.xml
            - name: Coverage Report
              uses: dorny/test-reporter@v1
              if: always()
              with:
                name: Maven Tests
                path: $GITHUB_WORKSPACE/clover.xml
                reporter: java-junit
                fail-on-error: true

  cypress:
    machine:
      image: ubuntu-2004:current
    parameters:
      upgrade:
        description: "If true, will install the latest stable version and test upgrade"
        default: false
        type: boolean
    parallelism: 4
    environment:
      TEST_RESULTS: /tmp/test-results
    steps:
      - prepare_build:
          upgrade: << parameters.upgrade >>
      - prepare_site:
          upgrade: << parameters.upgrade >>
      - run:
          name: Run Cypress tests
          command: ddev dkan-module-test-cypress-ci

workflows:
  version: 2
  install_and_test:
    jobs:
      - phpunit:
          name: install_test_phpunit
      - cypress:
          name: install_test_cypress
  upgrade_and_test:
    jobs:
      - phpunit:
          name: upgrade_test_phpunit
          upgrade: true
      - cypress:
          name: upgrade_test_cypress
          upgrade: true
